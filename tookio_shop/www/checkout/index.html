{% extends "templates/web.html" %}

{% block style %}
<style>
    body {
        background-color: #f8f9fa;
    }
    .checkout-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    .plan-summary {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    .payment-form {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        border: 1px solid #e9ecef;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    .price-display {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="checkout-container">
    <h1>Complete Your Subscription</h1>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    
    {% if plan %}
    <!-- Plan Summary -->
    <div class="plan-summary">
        <h3>Plan Summary</h3>
        <div class="row">
            <div class="col-md-8">
                <h4>{{ plan.name }}</h4>
                <p>{{ plan.description or 'Upgrade your business capabilities' }}</p>
                <ul>
                    <li>{{ plan.custom_item_limits }} items allowed</li>
                    <li>{{ plan.custom_shop_limit }} shop(s) allowed</li>
                    <li>Unlimited sales invoices</li>
                </ul>
            </div>
            <div class="col-md-4 text-right">
                <div class="price-display">KSh {{ plan.cost or 0 }}</div>
                <small class="text-muted">per month</small>
            </div>
        </div>
    </div>

    <!-- Payment Form -->
    <div class="payment-form">
        <h3>Payment Details</h3>
        <div id="payment-message" class="alert" style="display: none;"></div>
        <form id="checkout-form">
            <div class="form-group">
                <label for="phone">M-Pesa Phone Number (07xxxxxxxx)</label>
                <input type="tel" id="phone" name="phone" class="form-control" 
                       placeholder="e.g. 0712345678" 
                       value="{{ customer.mobile_no or '' }}" 
                       required>
            </div>
            
            <button type="button" id="pay-button" class="btn btn-primary">
                Pay KSh {{ plan.cost or 0 }} with M-Pesa
            </button>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    let checkoutRequestId = null;
    let statusCheckInterval = null;

    $('#pay-button').on('click', function() {
        var phone_number = $('#phone').val();
        var plan_name = "{{ plan.name if plan else '' }}";
        var payButton = $(this);
        var paymentMessage = $('#payment-message');

        if (!phone_number) {
            paymentMessage.text('Please enter your M-Pesa phone number (e.g. 0712345678).').addClass('alert-danger').show();
            return;
        }

        if (!plan_name) {
            paymentMessage.text('Plan information not available. Please try again.').addClass('alert-danger').show();
            return;
        }

        // Disable button and show loading state
        payButton.prop('disabled', true).text('Processing...');
        paymentMessage.hide();

        frappe.call({
            method: 'tookio_shop.www.checkout.index.trigger_mpesa_payment',
            args: {
                plan_name: plan_name,
                phone_number: phone_number
            },
            callback: function(r) {
                // Re-enable button
                payButton.prop('disabled', false).text('Pay KSh {{ plan.cost or 0 if plan else 0 }} with M-Pesa');

                if (r.message && r.message.ResponseCode == '0') {
                    checkoutRequestId = r.message.CheckoutRequestID;
                    paymentMessage.text('STK push sent to your phone. Please enter your M-Pesa PIN to complete the payment. Checking status...').removeClass('alert-danger').addClass('alert-success').show();
                    
                    // Start checking transaction status every 5 seconds
                    startStatusChecking();
                } else {
                    paymentMessage.text(r.message.errorMessage || 'An error occurred. Please try again.').removeClass('alert-success').addClass('alert-danger').show();
                }
            },
            error: function(r) {
                // Re-enable button
                payButton.prop('disabled', false).text('Pay KSh {{ plan.cost or 0 if plan else 0 }} with M-Pesa');
                paymentMessage.text('An unexpected error occurred. Please try again.').removeClass('alert-success').addClass('alert-danger').show();
            }
        });
    });

    function startStatusChecking() {
        let checkCount = 0;
        const maxChecks = 24; // Check for 2 minutes (24 * 5 seconds)
        
        statusCheckInterval = setInterval(function() {
            checkCount++;
            
            if (checkCount > maxChecks || !checkoutRequestId) {
                clearInterval(statusCheckInterval);
                $('#payment-message').text('Payment status check timed out. Please check your M-Pesa messages or refresh the page.').removeClass('alert-success').addClass('alert-warning').show();
                return;
            }

            frappe.call({
                method: 'tookio_mpesa.utils.query_transaction_status',
                args: {
                    checkout_request_id: checkoutRequestId
                },
                callback: function(r) {
                    if (r.message && r.message.success) {
                        const status = r.message.transaction_status;
                        const resultDesc = r.message.result_desc;
                        
                        if (status === 'Success') {
                            clearInterval(statusCheckInterval);
                            $('#payment-message').text('Payment successful! Thank you for your payment.').removeClass('alert-warning').addClass('alert-success').show();
                            
                            // Redirect to success page or reload after 3 seconds
                            setTimeout(function() {
                                window.location.href = '/subscriptions';
                            }, 3000);
                        } else if (status === 'Failed') {
                            clearInterval(statusCheckInterval);
                            $('#payment-message').text('Payment failed: ' + (resultDesc || 'Please try again.')).removeClass('alert-success alert-warning').addClass('alert-danger').show();
                        }
                        // If still pending, continue checking
                    }
                },
                error: function(r) {
                    // Stop checking on authentication errors (403, etc.)
                    if (r.exc && (r.exc.includes('403') || r.exc.includes('authentication failed') || r.exc.includes('M-Pesa authentication'))) {
                        clearInterval(statusCheckInterval);
                        $('#payment-message').text('Payment initiated successfully. Please check your M-Pesa messages for confirmation. Due to system limitations, automatic status checking is temporarily unavailable.').removeClass('alert-success').addClass('alert-info').show();
                    }
                    // Continue checking for other errors
                    console.log('Status check error:', r);
                }
            });
        }, 5000); // Check every 5 seconds
    }
});
</script>
{% endblock %}
