{% extends "templates/web.html" %}

{% block style %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    body {
        background-color: #f8f9fa;
    }
    .checkout-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    .plan-summary {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    .payment-form {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        border: 1px solid #e9ecef;
    }
    .payment-instructions {
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    .till-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #007bff;
        margin: 1rem 0;
    }
    .amount-display {
        font-size: 1.8rem;
        font-weight: bold;
        color: #28a745;
        margin: 1rem 0;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
    }
    .btn-primary:hover {
        background-color: #0056b3;
    }
    .price-display {
        font-size: 2rem;
        font-weight: bold;
        color: #28a745;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="checkout-container">
    <h1>Complete Your Subscription</h1>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    
    {% if plan %}
    <!-- Plan Summary -->
    <div class="plan-summary">
        <h3>Plan Summary</h3>
        <div class="row">
            <div class="col-md-8">
                <h4>{{ plan.name }}</h4>
                <p>{{ plan.description or 'Upgrade your business capabilities' }}</p>
                <ul>
                    <li>{{ plan.custom_item_limits }} items allowed</li>
                    <li>{{ plan.custom_shop_limit }} shop(s) allowed</li>
                    <li>Unlimited sales invoices</li>
                </ul>
            </div>
            <div class="col-md-4 text-right">
                <div class="price-display">KSh {{ plan.cost or 0 }}</div>
                <small class="text-muted">per month</small>
            </div>
        </div>
    </div>

    <!-- Payment Instructions -->
    <div class="payment-instructions">
        <h3><i class="fa fa-mobile" style="color: #28a745;"></i> M-Pesa Payment Instructions</h3>
        <p><strong>Follow these steps to complete your payment:</strong></p>
        
        <div class="row">
            <div class="col-md-6">
                <h4>1. Go to M-Pesa Menu</h4>
                <p>• Open M-Pesa on your phone<br>
                • Select "Lipa na M-Pesa"<br>
                • Choose "Buy Goods and Services"</p>
            </div>
            <div class="col-md-6">
                <h4>2. Enter Till Details</h4>
                <p><strong>Till Number:</strong></p>
                <div class="till-number">6547212</div>
                <p><strong>Amount:</strong></p>
                <div class="amount-display">KSh {{ plan.cost or 0 }}</div>
            </div>
        </div>
        
        <div class="alert alert-info">
            <strong>3. Complete Payment & Get Confirmation</strong><br>
            After successful payment, you will receive an M-Pesa confirmation message. 
            Enter the confirmation code below and click "Confirm Payment" to activate your subscription.
        </div>
    </div>

    <!-- Payment Form -->
    <div class="payment-form">
        <h3>Confirm Your Payment</h3>
        <div id="payment-message" class="alert" style="display: none;"></div>
        <form id="checkout-form">
            <div class="form-group">
                <label for="phone">Your M-Pesa Phone Number</label>
                <input type="tel" id="phone" name="phone" class="form-control" 
                       placeholder="e.g. 0712345678" 
                       value="{{ customer.mobile_no or '' }}" 
                       required>
                <small class="form-text text-muted">The phone number you used for M-Pesa payment</small>
            </div>
            
            <div class="form-group">
                <label for="transaction-code">M-Pesa Confirmation Code</label>
                <input type="text" id="transaction-code" name="transaction_code" class="form-control" 
                       placeholder="e.g. QJ79XZKL32" 
                       style="text-transform: uppercase;"
                       required>
                <small class="form-text text-muted">Enter the confirmation code from your M-Pesa message</small>
            </div>
            
            <div class="alert alert-warning">
                <strong>Important:</strong> Only click "Confirm Payment" after you have successfully paid 
                <strong>KSh {{ plan.cost or 0 }}</strong> to Till Number <strong>6547212</strong> 
                and received your M-Pesa confirmation message.
            </div>
            
            <button type="button" id="confirm-button" class="btn btn-primary">
                <i class="fa fa-check"></i> Confirm Payment & Activate Subscription
            </button>
        </form>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
$(document).ready(function() {
    // Auto-uppercase transaction code input
    $('#transaction-code').on('input', function() {
        this.value = this.value.toUpperCase();
    });

    $('#confirm-button').on('click', function() {
        var phone_number = $('#phone').val();
        var transaction_code = $('#transaction-code').val();
        var plan_name = "{{ plan.name if plan else '' }}";
        var confirmButton = $(this);
        var paymentMessage = $('#payment-message');

        // Validation
        if (!phone_number) {
            paymentMessage.text('Please enter your M-Pesa phone number.').removeClass('alert-success alert-info').addClass('alert-danger').show();
            return;
        }

        if (!transaction_code) {
            paymentMessage.text('Please enter your M-Pesa confirmation code.').removeClass('alert-success alert-info').addClass('alert-danger').show();
            return;
        }

        if (transaction_code.length < 8) {
            paymentMessage.text('Please enter a valid M-Pesa confirmation code (usually 8-10 characters).').removeClass('alert-success alert-info').addClass('alert-danger').show();
            return;
        }

        if (!plan_name) {
            paymentMessage.text('Plan information not available. Please try again.').removeClass('alert-success alert-info').addClass('alert-danger').show();
            return;
        }

        // Disable button and show processing state
        confirmButton.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Verifying Payment...');
        paymentMessage.text('Verifying your payment details...').removeClass('alert-danger').addClass('alert-info').show();

        // Simulate payment verification delay (3-5 seconds)
        setTimeout(function() {
            frappe.call({
                method: 'tookio_shop.www.checkout.index.confirm_payment',
                args: {
                    plan_name: plan_name,
                    phone_number: phone_number,
                    transaction_code: transaction_code
                },
                callback: function(r) {
                    if (r.message && r.message.success) {
                        paymentMessage.html(
                            '<strong>Payment Confirmed!</strong><br>' +
                            r.message.message + '<br>' +
                            '<small>Sales Invoice: ' + r.message.sales_invoice + '</small>'
                        ).removeClass('alert-danger alert-info').addClass('alert-success').show();
                        
                        confirmButton.html('<i class="fa fa-check"></i> Payment Successful!').addClass('btn-success').removeClass('btn-primary');
                        
                        // Redirect to subscriptions page after 3 seconds
                        setTimeout(function() {
                            window.location.href = '/subscriptions?success=1';
                        }, 3000);
                    } else {
                        confirmButton.prop('disabled', false).html('<i class="fa fa-check"></i> Confirm Payment & Activate Subscription');
                        paymentMessage.text('Payment confirmation failed. Please try again or contact support.').removeClass('alert-success alert-info').addClass('alert-danger').show();
                    }
                },
                error: function(r) {
                    confirmButton.prop('disabled', false).html('<i class="fa fa-check"></i> Confirm Payment & Activate Subscription');
                    var errorMsg = 'An error occurred while confirming your payment. Please try again.';
                    if (r.exc_type && r.exc_type.includes('ValidationError')) {
                        errorMsg = r._server_messages ? JSON.parse(r._server_messages)[0] : errorMsg;
                    }
                    paymentMessage.text(errorMsg).removeClass('alert-success alert-info').addClass('alert-danger').show();
                }
            });
        }, Math.random() * 2000 + 3000); // Random delay between 3-5 seconds
    });
});
</script>
{% endblock %}
